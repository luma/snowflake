require File.expand_path(File.join(File.dirname(__FILE__), '..', 'spec_helper'))

describe Snowflake::PropertyPrototype do
#  before(:all) do
#  end
  
  describe "#to_property" do
    it "returns a new property for a node" do
      node = TestNode.new
      pt = Snowflake::PropertyPrototype.new(TestNode, :name, String)
      property = pt.to_property(node)
      puts property.inspect
      property.is_a?(Snowflake::Properties::String).should be_true
    end
  end
  
  describe "#property_class_for_type" do
    it "returns a Property class for @type" do
      pt = Snowflake::PropertyPrototype.new(TestNode, :name, String)
      pt.property_class_for_type.should == Snowflake::Properties::String
    end
  end
  
  describe "#value_for_key" do
    after(:each) do
      #Snowflake.flushdb
      Snowflake.connection.del( 'foo' )
    end

    it "returns a String value for a key" do
      pt = Snowflake::PropertyPrototype.new(TestNode, :name, String)
      Snowflake.connection['foo'] = 'bar'
      pt.value_for_key('foo').should == 'bar'
    end
    
    it "returns a Boolean value for a key" do
      pt = Snowflake::PropertyPrototype.new(TestNode, :name, ::Snowflake::Properties::Boolean)
      Snowflake.connection['foo'] = '1'
      pt.value_for_key('foo').should == '1'
    end

    it "returns a Integer value for a key" do
      pt = Snowflake::PropertyPrototype.new(TestNode, :name, Integer)
      Snowflake.connection['foo'] = 100
      pt.value_for_key('foo').should == '100'
    end

    it "returns a Counter value for a key" do
      pt = Snowflake::PropertyPrototype.new(TestNode, :name, ::Snowflake::Properties::Counter)
      Snowflake.connection['foo'] = 2
      pt.value_for_key('foo').should == '2'
    end

    it "returns a Set value for a key" do
      pt = Snowflake::PropertyPrototype.new(TestNode, :name, ::Snowflake::Properties::Set)
      Snowflake.connection.sadd( 'foo', 'foo')
      Snowflake.connection.sadd( 'foo', 'bar')
      Snowflake.connection.smembers( 'foo' ).should == [ 'foo', 'bar' ]
    end

    it "returns a List value for a key" do
      pt = Snowflake::PropertyPrototype.new(TestNode, :name, ::Snowflake::Properties::List)
      Snowflake.connection.rpush( 'foo', 'foo')
      Snowflake.connection.rpush( 'foo', 'bar')
      Snowflake.connection.lrange( 'foo', 0, -1 ).should == ['foo', 'bar']
    end

    it "returns a Hash value for a key" do
      pt = Snowflake::PropertyPrototype.new(TestNode, :name, ::Snowflake::Properties::Hash)
      Snowflake.connection.hmset( 'foo', :foo, 'bar' )
      Snowflake.connection.hgetall( 'foo' ).should == {'foo' => 'bar'}
    end
  end
end

=begin
# Retrieves a value from Redis by it's Key, the retrieval method used depends on the
# Properties type.
#
# @todo This is a bit of a kludge right now. I'd rather this method was necessary at all.
#
# @param [#to_s] key
#     The Property key to retrieve
#
# @return [Various]
#     The Property value
#
# @api semi public
def value_for_key(key)
  case @type.to_s
  when "Snowflake::Properties::Set"
    Snowflake.connection.smembers( key )
  when "Snowflake::Properties::List"
    Snowflake.connection.lrange( key, 0, -1 )
  when "Snowflake::Properties::Hash"
    Snowflake.connection.hgetall( key )
  else
    # When in doubt, assume a string
    Snowflake.connection.get( key )
  end
end
=end